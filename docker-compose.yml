# docker-compose.yml - FreeSWITCH AI Robot
version: '3.8'

services:
  ai-robot:
    build: .
    container_name: ai-robot
    ports:
      - "8080:8080"  # API端口
      - "8081:8081"  # WebUI端口
    environment:
      # Redis配置
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=
      # MySQL配置
      - MYSQL_ENABLED=true
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:-aibot}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-aibot123}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-aibot}
      # API配置
      - API_ENABLED=true
      - API_HOST=0.0.0.0
      - API_PORT=8080
      # WebUI配置
      - WEBUI_ENABLED=true
      - WEBUI_HOST=0.0.0.0
      - WEBUI_PORT=8081
      # 认证配置
      - AUTH_ENABLED=true
      - AUTH_ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - AUTH_ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - AUTH_JWT_SECRET=${JWT_SECRET:-change-this-jwt-secret-key}
      - AUTH_JWT_EXPIRATION=86400
      # FreeSWITCH配置
      - FREESWITCH_ENABLED=false
      - FREESWITCH_HOST=${FS_HOST:-localhost}
      - FREESWITCH_PORT=8021
      - FREESWITCH_PASSWORD=${FS_PASSWORD:-ClueCon}
      - FREESWITCH_AUDIO_SAMPLE_RATE=8000
      - FREESWITCH_DIALPLAN_CONTEXT=public
      - FREESWITCH_DIALPLAN_EXTENSION=ai_robot
      # ASR配置
      - ASR_ENABLED=true
      - ASR_PROVIDER=funasr
      - ASR_WS_URL=ws://funasr:10095
      - ASR_SAMPLE_RATE=16000
      # LLM配置
      - LLM_ENABLED=false
      - LLM_PROVIDER=openai
      - LLM_API_URL=${LLM_API_URL:-http://localhost:8000/v1/chat/completions}
      - LLM_MODEL=gpt-3.5-turbo
      - LLM_TEMPERATURE=0.7
      - LLM_MAX_TOKENS=2000
      # TTS配置
      - TTS_ENABLED=true
      - TTS_PROVIDER=cosyvoice
      - TTS_API_URL=http://cosyvoice:50000/tts
      - TTS_VOICE=zh-CN-XiaoxiaoNeural
      # 日志配置
      - LOG_LEVEL=INFO
      - LOG_FILE=/var/log/ai-robot/app.log
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      funasr:
        condition: service_started
      cosyvoice:
        condition: service_started
    restart: unless-stopped
    volumes:
      - ./logs:/var/log/ai-robot
      - ./scenarios:/app/scenarios
      - ./contacts:/app/contacts
      - ./data:/app/data
    networks:
      - ai-robot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mysql:
    image: mysql:8.0
    container_name: ai-robot-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root123}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-aibot}
      - MYSQL_USER=${MYSQL_USER:-aibot}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-aibot123}
      - TZ=Asia/Shanghai
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./storage/init_database.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root123}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ai-robot-network

  redis:
    image: redis:7-alpine
    container_name: ai-robot-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass "${REDIS_PASSWORD:-}"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-robot-network

  # FunASR语音识别服务
  funasr:
    image: registry.cn-hangzhou.aliyuncs.com/funasr_repo/funasr:funasr-runtime-sdk-online-cpu-0.1.10
    container_name: ai-robot-funasr
    ports:
      - "10095:10095"  # WebSocket端口
    environment:
      - WORKSPACE=/workspace/models
    command: |
      bash -c "
      if [ ! -d /workspace/models/damo ]; then
        echo 'Downloading FunASR models...'
        mkdir -p /workspace/models
      fi
      /workspace/FunASR/runtime/onnxruntime/bin/funasr-wss-server-2pass \
        --download-model-dir /workspace/models \
        --model-dir damo/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-onnx \
        --online-model-dir damo/speech_paraformer-large_asr_nat-zh-cn-16k-common-vocab8404-online-onnx \
        --vad-dir damo/speech_fsmn_vad_zh-cn-16k-common-onnx \
        --punc-dir damo/punc_ct-transformer_zh-cn-common-vad_realtime-vocab272727-onnx \
        --itn-dir thuduj12/fst_itn_zh \
        --port 10095
      "
    volumes:
      - funasr_models:/workspace/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10095/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - ai-robot-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

  # CosyVoice语音合成服务
  cosyvoice:
    image: registry.cn-hangzhou.aliyuncs.com/modelscope-repo/cosyvoice:v1.0
    container_name: ai-robot-cosyvoice
    ports:
      - "50000:50000"  # HTTP API端口
    environment:
      - MODEL_DIR=/workspace/models
      - CUDA_VISIBLE_DEVICES=-1  # CPU模式，如有GPU设置为0
    command: |
      bash -c "
      if [ ! -d /workspace/models/CosyVoice-300M ]; then
        echo 'Downloading CosyVoice models...'
        mkdir -p /workspace/models
      fi
      python3 /workspace/CosyVoice/cosyvoice/bin/cosyvoice_server.py \
        --port 50000 \
        --model_dir /workspace/models/CosyVoice-300M
      "
    volumes:
      - cosyvoice_models:/workspace/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:50000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s
    networks:
      - ai-robot-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  funasr_models:
    driver: local
  cosyvoice_models:
    driver: local

networks:
  ai-robot-network:
    driver: bridge
