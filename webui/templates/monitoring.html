<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeSWITCH AI Robot - 实时监控</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background-color: #343a40; }
        .sidebar .nav-link { color: rgba(255,255,255,.75); padding: 0.75rem 1rem; }
        .sidebar .nav-link:hover { color: #fff; background-color: rgba(255,255,255,.1); }
        .sidebar .nav-link.active { color: #fff; background-color: #0d6efd; }
        .conversation-log { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; }
        .log-entry { padding: 0.25rem 0; border-bottom: 1px solid #f0f0f0; }
        .log-timestamp { color: #6c757d; font-weight: bold; }
        .log-session { color: #007bff; }
        .log-message { margin-left: 1rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-2 sidebar p-0">
                <div class="p-3">
                    <h5 class="text-white mb-4">AI Robot管理系统</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="bi bi-house-door"></i> 仪表板</a></li>
                        <li class="nav-item"><a class="nav-link" href="/freeswitch"><i class="bi bi-server"></i> FreeSWITCH管理</a></li>
                        <li class="nav-item"><a class="nav-link" href="/scenarios"><i class="bi bi-robot"></i> 场景管理</a></li>
                        <li class="nav-item"><a class="nav-link" href="/outbound"><i class="bi bi-telephone-outbound"></i> 外呼管理</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/monitoring"><i class="bi bi-graph-up"></i> 实时监控</a></li>
                        <li class="nav-item"><a class="nav-link" href="/settings"><i class="bi bi-gear"></i> 系统设置</a></li>
                        <li class="nav-item mt-3"><a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-10 ms-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">实时监控</h1>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleAutoRefresh()">
                            <i class="bi bi-play-circle"></i> <span id="auto-refresh-text">自动刷新</span>
                        </button>
                    </div>
                </div>

                <!-- 活跃通话 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">活跃通话 (<span id="active-count">0</span>)</h6>
                                <small class="text-muted">实时更新</small>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped" id="active-calls-table">
                                        <thead>
                                            <tr>
                                                <th>会话ID</th>
                                                <th>主叫号码</th>
                                                <th>当前状态</th>
                                                <th>开始时间</th>
                                                <th>持续时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="active-calls-tbody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">暂无活跃通话</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 对话记录 -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">实时对话记录</h6>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="session-filter">
                                        <option value="">所有会话</option>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                        <i class="bi bi-trash"></i> 清空
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="conversation-log" id="conversation-log">
                                    <div class="text-center text-muted py-4">
                                        <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                                        <p class="mt-2">等待对话数据...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshInterval = null;
        let websocket = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveCalls();
            initWebSocket();
        });

        // 加载活跃通话
        async function loadActiveCalls() {
            try {
                const response = await fetch('/api/monitoring/active-calls');
                const data = await response.json();

                if (data.success) {
                    updateActiveCallsTable(data.active_calls);
                }
            } catch (error) {
                console.error('加载活跃通话失败:', error);
            }
        }

        // 更新活跃通话表格
        function updateActiveCallsTable(calls) {
            const tbody = document.getElementById('active-calls-tbody');
            const count = document.getElementById('active-count');

            count.textContent = calls.length;

            if (calls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无活跃通话</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            calls.forEach(call => {
                const startTime = call.start_time ? new Date(call.start_time * 1000) : null;
                const duration = startTime ? Math.floor((Date.now() - startTime.getTime()) / 1000) : 0;
                const durationStr = formatDuration(duration);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${call.session_id}</td>
                    <td>${call.caller_id || '未知'}</td>
                    <td><span class="badge bg-primary">${call.state}</span></td>
                    <td>${startTime ? startTime.toLocaleTimeString() : '未知'}</td>
                    <td>${durationStr}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="endCall('${call.session_id}')">
                            <i class="bi bi-telephone-x"></i> 结束
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 初始化WebSocket连接
        function initWebSocket() {
            if (websocket) {
                websocket.close();
            }

            websocket = new WebSocket(`ws://${window.location.host}/api/monitoring/ws`);

            websocket.onopen = function(event) {
                console.log('WebSocket连接已建立');
            };

            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('解析WebSocket消息失败:', error);
                }
            };

            websocket.onclose = function(event) {
                console.log('WebSocket连接已关闭');
                // 自动重连
                setTimeout(initWebSocket, 3000);
            };

            websocket.onerror = function(error) {
                console.error('WebSocket错误:', error);
            };
        }

        // 处理WebSocket消息
        function handleWebSocketMessage(data) {
            if (data.type === 'conversation_log') {
                addConversationLog(data);
            } else if (data.type === 'call_update') {
                loadActiveCalls();
            }
        }

        // 添加对话记录
        function addConversationLog(data) {
            const logContainer = document.getElementById('conversation-log');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-session">[${data.session_id}]</span>
                <span class="log-message">${data.message}</span>
            `;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // 限制日志条数
            while (logContainer.children.length > 1000) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // 格式化持续时间
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 结束通话
        async function endCall(sessionId) {
            if (!confirm('确定要结束这个通话吗？')) return;

            try {
                const response = await fetch(`/call/end/${sessionId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadActiveCalls();
                } else {
                    alert('结束通话失败');
                }
            } catch (error) {
                console.error('结束通话失败:', error);
                alert('结束通话失败，请重试');
            }
        }

        // 刷新数据
        function refreshData() {
            loadActiveCalls();
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            const button = event.target.closest('button');
            const textSpan = document.getElementById('auto-refresh-text');
            const icon = button.querySelector('i');

            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                textSpan.textContent = '自动刷新';
                icon.className = 'bi bi-play-circle';
                button.classList.remove('active');
            } else {
                autoRefreshInterval = setInterval(refreshData, 5000);
                textSpan.textContent = '停止刷新';
                icon.className = 'bi bi-pause-circle';
                button.classList.add('active');
            }
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('conversation-log').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                    <p class="mt-2">日志已清空</p>
                </div>
            `;
        }

        // 登出
        async function logout() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (websocket) {
                websocket.close();
            }

            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>