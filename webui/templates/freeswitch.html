<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeSWITCH AI Robot - FreeSWITCH管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background-color: #343a40; }
        .sidebar .nav-link { color: rgba(255,255,255,.75); padding: 0.75rem 1rem; }
        .sidebar .nav-link:hover { color: #fff; background-color: rgba(255,255,255,.1); }
        .sidebar .nav-link.active { color: #fff; background-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-2 sidebar p-0">
                <div class="p-3">
                    <h5 class="text-white mb-4">AI Robot管理系统</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="bi bi-house-door"></i> 仪表板</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/freeswitch"><i class="bi bi-server"></i> FreeSWITCH管理</a></li>
                        <li class="nav-item"><a class="nav-link" href="/scenarios"><i class="bi bi-robot"></i> 场景管理</a></li>
                        <li class="nav-item"><a class="nav-link" href="/outbound"><i class="bi bi-telephone-outbound"></i> 外呼管理</a></li>
                        <li class="nav-item"><a class="nav-link" href="/monitoring"><i class="bi bi-graph-up"></i> 实时监控</a></li>
                        <li class="nav-item"><a class="nav-link" href="/settings"><i class="bi bi-gear"></i> 系统设置</a></li>
                        <li class="nav-item mt-3"><a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-10 ms-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">FreeSWITCH管理</h1>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInstanceModal">
                        <i class="bi bi-plus-circle"></i> 添加实例
                    </button>
                </div>

                <!-- FreeSWITCH实例列表 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">FreeSWITCH实例列表</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="instances-table">
                                <thead>
                                    <tr>
                                        <th>实例ID</th>
                                        <th>主机地址</th>
                                        <th>端口</th>
                                        <th>状态</th>
                                        <th>启用的场景</th>
                                        <th>描述</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="instances-tbody">
                                    <!-- 动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加实例模态框 -->
    <div class="modal fade" id="addInstanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加FreeSWITCH实例</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-instance-form">
                        <div class="mb-3">
                            <label class="form-label">实例ID</label>
                            <input type="text" class="form-control" name="instance_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">主机地址</label>
                            <input type="text" class="form-control" name="host" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">端口</label>
                            <input type="number" class="form-control" name="port" value="8021" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">启用的场景</label>
                            <select multiple class="form-select" name="enabled_scenarios">
                                <option value="default">默认场景</option>
                                <option value="sales">销售场景</option>
                                <option value="support">客服场景</option>
                                <option value="survey">调研场景</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addInstance()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadInstances();
        });

        async function loadInstances() {
            try {
                const response = await fetch('/api/freeswitch/instances');
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('instances-tbody');
                    tbody.innerHTML = '';

                    for (const [instanceId, instance] of Object.entries(data.instances)) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${instanceId}</td>
                            <td>${instance.host}</td>
                            <td>${instance.port}</td>
                            <td><span class="badge bg-secondary">未连接</span></td>
                            <td>${instance.enabled_scenarios ? instance.enabled_scenarios.join(', ') : ''}</td>
                            <td>${instance.description || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editInstance('${instanceId}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteInstance('${instanceId}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                }
            } catch (error) {
                console.error('加载实例列表失败:', error);
            }
        }

        async function addInstance() {
            const form = document.getElementById('add-instance-form');
            const formData = new FormData(form);
            const data = {
                instance_id: formData.get('instance_id'),
                host: formData.get('host'),
                port: parseInt(formData.get('port')),
                password: formData.get('password'),
                enabled_scenarios: Array.from(form.querySelector('[name="enabled_scenarios"]').selectedOptions).map(opt => opt.value),
                description: formData.get('description')
            };

            try {
                const response = await fetch('/api/freeswitch/instances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addInstanceModal')).hide();
                    form.reset();
                    loadInstances();
                } else {
                    alert('添加失败: ' + result.message);
                }
            } catch (error) {
                console.error('添加实例失败:', error);
                alert('添加失败，请重试');
            }
        }

        async function deleteInstance(instanceId) {
            if (!confirm('确定要删除这个实例吗？')) return;

            try {
                const response = await fetch(`/api/freeswitch/instances/${instanceId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    loadInstances();
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('删除实例失败:', error);
                alert('删除失败，请重试');
            }
        }

        function editInstance(instanceId) {
            alert('编辑功能暂未实现');
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>